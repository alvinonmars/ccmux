<style>
/* Date group headers */
.date-group {{ margin-bottom: 20px; }}
.date-header {{
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 4px 8px;
  position: sticky;
  top: 60px;
  z-index: 50;
  background: #0f0f0f;
}}
.date-label {{ font-size: 1.05em; font-weight: 600; color: #fff; }}
.date-count {{
  font-size: 0.8em;
  color: rgba(255,255,255,0.4);
  background: rgba(255,255,255,0.08);
  padding: 2px 8px;
  border-radius: 12px;
}}
/* Grid */
.gallery {{
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 3px;
}}
@media (min-width: 640px) {{ .gallery {{ grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 4px; }} }}
@media (min-width: 1024px) {{ .gallery {{ grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 4px; }} }}
.gallery .item {{
  position: relative;
  overflow: hidden;
  cursor: pointer;
  border-radius: 3px;
  aspect-ratio: 1;
  background: #1a1a1a;
}}
.gallery .item img {{
  width: 100%; height: 100%; object-fit: cover; display: block;
  transition: transform 0.3s ease, opacity 0.4s;
  opacity: 0;
}}
.gallery .item img.loaded {{ opacity: 1; }}
.gallery .item:hover img {{ transform: scale(1.05); }}
.gallery .item .overlay {{
  position: absolute; bottom: 0; left: 0; right: 0;
  padding: 20px 8px 5px;
  background: linear-gradient(transparent, rgba(0,0,0,0.7));
  opacity: 0; transition: opacity 0.2s;
  font-size: 0.7em; color: #fff;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}}
.gallery .item:hover .overlay {{ opacity: 1; }}
/* Loading skeleton */
.gallery .item::before {{
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(110deg, #1a1a1a 30%, #252525 50%, #1a1a1a 70%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
}}
.gallery .item:has(img.loaded)::before {{ display: none; }}
@keyframes shimmer {{ to {{ background-position: -200% 0; }} }}
/* Toolbar */
.toolbar {{
  display: flex; gap: 10px; align-items: center; margin: 8px 0; flex-wrap: wrap;
}}
.toolbar .count {{
  color: rgba(255,255,255,0.5); font-size: 0.85em;
  display: flex; gap: 8px; align-items: center;
}}
.badge {{
  background: rgba(255,255,255,0.1); padding: 3px 10px; border-radius: 12px; font-size: 0.85em;
}}
/* Scroll loader */
#scroll-loader {{
  text-align: center; padding: 24px; color: rgba(255,255,255,0.3); font-size: 0.9em;
}}
#scroll-loader .spinner {{
  display: inline-block; width: 20px; height: 20px;
  border: 2px solid rgba(255,255,255,0.1); border-top-color: rgba(255,255,255,0.4);
  border-radius: 50%; animation: spin 0.8s linear infinite;
}}
@keyframes spin {{ to {{ transform: rotate(360deg); }} }}
/* Lightbox */
.lightbox {{
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.96); z-index: 1000;
  flex-direction: column; align-items: center; justify-content: center;
}}
.lightbox.active {{ display: flex; }}
.lightbox .lb-img-wrap {{
  flex: 1; display: flex; align-items: center; justify-content: center;
  width: 100%; padding: 10px; overflow: hidden;
}}
.lightbox img {{
  max-width: 95vw; max-height: 80vh; object-fit: contain; border-radius: 4px;
  transition: opacity 0.2s; user-select: none; -webkit-user-drag: none;
}}
.lightbox .close {{
  position: absolute; top: 12px; right: 16px;
  color: rgba(255,255,255,0.7); font-size: 2em; cursor: pointer; z-index: 1001;
  width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
  border-radius: 50%; transition: background 0.2s;
}}
.lightbox .close:hover {{ background: rgba(255,255,255,0.1); color: #fff; }}
.lightbox .nav {{
  position: absolute; top: 50%; transform: translateY(-50%);
  color: rgba(255,255,255,0.6); font-size: 2.5em; cursor: pointer;
  padding: 20px 16px; user-select: none; z-index: 1001;
  border-radius: 8px; transition: background 0.2s, color 0.2s;
}}
.lightbox .nav:hover {{ background: rgba(255,255,255,0.08); color: #fff; }}
.lightbox .nav.prev {{ left: 4px; }}
.lightbox .nav.next {{ right: 4px; }}
.lightbox .bottom-bar {{
  display: flex; align-items: center; justify-content: center;
  gap: 20px; padding: 12px 20px;
  color: rgba(255,255,255,0.6); font-size: 0.85em; width: 100%;
  background: rgba(0,0,0,0.5);
}}
.lightbox .bottom-bar a {{
  color: #60a5fa; padding: 6px 14px;
  border: 1px solid rgba(96,165,250,0.4); border-radius: 6px; font-size: 0.9em;
  transition: background 0.2s;
}}
.lightbox .bottom-bar a:hover {{ background: rgba(96,165,250,0.15); text-decoration: none; }}
@media (max-width: 640px) {{
  .lightbox .nav {{ font-size: 1.8em; padding: 12px 8px; }}
  .lightbox img {{ max-width: 100vw; max-height: 75vh; border-radius: 0; }}
  .date-header {{ top: 56px; }}
}}
</style>

<div class="toolbar">
  <span class="count">
    <span class="badge">{file_count} photos</span>
    <span class="badge">{date_count} days</span>
  </span>
</div>

<div id="gallery-root"></div>
<div id="scroll-loader"><span class="spinner"></span> Loading more...</div>

<div class="lightbox" id="lightbox">
  <span class="close" onclick="closeLightbox()">&times;</span>
  <span class="nav prev" onclick="navLightbox(-1)">&#8249;</span>
  <div class="lb-img-wrap">
    <img id="lb-img" src="" alt="">
  </div>
  <span class="nav next" onclick="navLightbox(1)">&#8250;</span>
  <div class="bottom-bar">
    <span id="lb-name"></span>
    <span id="lb-idx"></span>
    <a id="lb-dl" href="" download>Download</a>
  </div>
</div>

<script>
const GROUPS = {groups_json};
const BATCH = 80;
const root = document.getElementById('gallery-root');
const loader = document.getElementById('scroll-loader');

// Flatten for lightbox
const allFiles = [];
GROUPS.forEach(g => g.photos.forEach(p => allFiles.push(p)));

// Track render progress per group
let gIdx = 0;   // current group index
let pIdx = 0;   // current photo index within group
let globalRendered = 0;
let currentGrid = null;
let loading = false;

function esc(s) {{ const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }}

// Render all items upfront (lightweight skeleton divs), lazy-load images on scroll
function renderAll() {{
  let idx = 0;
  GROUPS.forEach(g => {{
    const section = document.createElement('div');
    section.className = 'date-group';
    section.innerHTML = '<div class="date-header"><span class="date-label">'
      + esc(g.date) + '</span><span class="date-count">' + g.count + '</span></div>';
    const grid = document.createElement('div');
    grid.className = 'gallery';
    g.photos.forEach(p => {{
      const i = idx++;
      const item = document.createElement('div');
      item.className = 'item';
      item.onclick = () => openLightbox(i);
      item.innerHTML = '<img data-src="' + p.thumb + '" alt="' + esc(p.name) + '">'
        + '<div class="overlay">' + esc(p.name) + '</div>';
      grid.appendChild(item);
    }});
    section.appendChild(grid);
    root.appendChild(section);
  }});
  loader.style.display = 'none';
}}

// Lazy load images â€” only load when near viewport
const imgObserver = new IntersectionObserver((entries) => {{
  entries.forEach(entry => {{
    if (entry.isIntersecting) {{
      const img = entry.target;
      img.src = img.dataset.src;
      img.onload = () => img.classList.add('loaded');
      imgObserver.unobserve(img);
    }}
  }});
}}, {{ rootMargin: '400px' }});

renderAll();
document.querySelectorAll('.gallery img[data-src]').forEach(img => imgObserver.observe(img));

// Lightbox
let curIdx = 0;
function openLightbox(idx) {{
  curIdx = idx;
  const lb = document.getElementById('lightbox');
  const img = document.getElementById('lb-img');
  img.style.opacity = '0.3';
  img.src = allFiles[idx].url;
  img.onload = () => {{ img.style.opacity = '1'; }};
  document.getElementById('lb-name').textContent = allFiles[idx].name;
  document.getElementById('lb-idx').textContent = (idx+1) + ' / ' + allFiles.length;
  document.getElementById('lb-dl').href = allFiles[idx].url;
  lb.classList.add('active');
  document.body.style.overflow = 'hidden';
}}
function closeLightbox() {{
  document.getElementById('lightbox').classList.remove('active');
  document.body.style.overflow = '';
}}
function navLightbox(dir) {{
  curIdx = (curIdx + dir + allFiles.length) % allFiles.length;
  openLightbox(curIdx);
}}
document.addEventListener('keydown', e => {{
  const lb = document.getElementById('lightbox');
  if (!lb.classList.contains('active')) return;
  if (e.key === 'Escape') closeLightbox();
  if (e.key === 'ArrowLeft') navLightbox(-1);
  if (e.key === 'ArrowRight') navLightbox(1);
}});
// Touch swipe
let touchStartX = 0;
document.getElementById('lightbox').addEventListener('touchstart', e => {{
  touchStartX = e.changedTouches[0].screenX;
}}, {{passive: true}});
document.getElementById('lightbox').addEventListener('touchend', e => {{
  const diff = e.changedTouches[0].screenX - touchStartX;
  if (Math.abs(diff) > 50) navLightbox(diff > 0 ? -1 : 1);
}}, {{passive: true}});
</script>
